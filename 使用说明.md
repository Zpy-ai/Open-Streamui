# 知识库搜索系统使用说明

## 功能概述

本系统提供两个主要功能：
1. **知识库搜索** - 在已有知识库中搜索相关文档
2. **AI智能问答** - 支持基础AI问答和联网搜索增强

## 功能详细说明

### 1. 知识库搜索

#### 功能特点
- 混合搜索：结合关键词搜索和语义搜索
- 可调节语义搜索权重（0-1之间）
- 支持多个知识库选择
- 实时显示搜索耗时和结果数量
- AI自动生成搜索结果摘要

#### 使用方法
1. 在侧边栏选择知识库
2. 调节语义搜索权重（0=纯关键词搜索，1=纯语义搜索）
3. 设置返回结果数量
4. 在搜索框输入查询内容
5. 点击搜索按钮或按回车键
6. 查看搜索结果和AI生成的摘要

### 2. AI智能问答

#### 功能特点
- 基础AI问答：使用通义千问模型回答问题
- 联网搜索增强：可选择启用网络搜索来增强回答质量
- 多对话会话管理：支持创建、切换、删除多个对话会话
- 对话历史保存：每个会话独立保存对话记录
- 实时搜索状态显示：显示是否使用了网络搜索
- 侧边栏统一控制：页面切换、对话管理、AI设置都在侧边栏
- 智能操作按钮：每个AI回答都有重新生成和复制功能
- 简洁界面设计：专注于对话体验，移除不必要的统计信息

#### 使用方法
1. 在侧边栏的"功能选择"中切换到"AI问答"页面
2. 在侧边栏管理对话会话：
   - 输入名称并点击➕创建新对话
   - 点击对话名称切换到不同会话
   - 点击🗑️删除不需要的对话（默认对话不可删除）
3. 在侧边栏的"AI设置"中选择是否启用"联网搜索"
4. 在聊天输入框输入问题
5. 按回车或点击发送
6. 查看AI回答和搜索状态信息
7. 使用每个AI回答下方的操作按钮：
   - 🔄 重新回答：重新生成当前问题的回答
   - 📋 复制：显示可复制的回答内容
   - ⏰ 时间戳：显示回答生成时间

#### 联网搜索功能
- **启用时**：AI会先进行网络搜索，然后结合搜索结果和自身知识回答问题
- **禁用时**：AI仅使用自身的基础知识回答问题
- **搜索失败时**：自动回退到基础AI回答模式

## 网络搜索API说明

系统使用的联网搜索接口：
```bash
curl --location 'http://10.8.130.31:6008/api/websearch' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer sk-proj-mimouse' \
--data '{"query": "李白","tools": "quark_search"}'
```

### API参数说明
- `query`: 搜索查询内容
- `tools`: 搜索工具，默认使用"quark_search"
- `Authorization`: 需要提供有效的Bearer token

## 配置说明

### 主要配置项

#### OpenAI配置（通义千问）
```json
"openai": {
  "api_key": "你的通义千问API密钥",
  "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
  "model": "qwen-plus"
}
```

#### 网络搜索配置
```json
"web_search": {
  "url": "http://10.8.130.31:6008/api/websearch",
  "api_key": "sk-proj-mimouse",
  "default_tool": "quark_search",
  "timeout": 30
}
```

#### 聊天配置
```json
"chat": {
  "max_history_length": 50,
  "max_message_length": 2000,
  "default_web_search_enabled": false
}
```

## 运行方式

```bash
# 安装依赖
pip install -r requirements.txt

# 运行应用
streamlit run ai.py
```

## 注意事项

1. **配置文件**：确保`config.json`文件存在且配置正确
2. **网络连接**：联网搜索功能需要网络连接和有效的API密钥
3. **服务可用性**：确保所有配置的服务（Meilisearch、向量嵌入、通义千问API）都可正常访问
4. **对话历史**：对话历史保存在会话中，刷新页面会清空历史记录
5. **搜索超时**：网络搜索默认超时时间为30秒，可在配置中调整

## 故障排除

### 常见问题

1. **导入错误**：检查是否安装了所有依赖包
2. **配置错误**：检查`config.json`文件格式和内容是否正确
3. **网络搜索失败**：检查网络连接和API密钥是否有效
4. **AI回答异常**：检查通义千问API配置和网络连接

### 调试方法

1. 运行`python test_imports.py`检查模块导入
2. 查看Streamlit控制台输出的错误信息
3. 检查各个服务的网络连接状态
4. 验证API密钥的有效性

## 更新日志

### 最新版本
- ✅ 删除了不需要的聊天服务文件
- ✅ 新增AI智能问答页面
- ✅ 集成联网搜索功能
- ✅ 支持可选的网络搜索增强
- ✅ 完善的对话历史管理
- ✅ 实时搜索状态显示

### 🆕 最新优化功能（v2.0）
- ✅ **固定控制栏**：联网搜索开关和清空历史按钮固定在页面顶部
- ✅ **智能操作按钮**：每个AI回答都提供重新回答和复制功能
- ✅ **时间戳显示**：显示每个回答的生成时间
- ✅ **增强统计**：显示总消息数、用户消息数、AI回答数和搜索使用次数
- ✅ **便捷复制**：点击复制按钮显示格式化的可复制内容
- ✅ **用户体验优化**：无需滚动到页面顶部即可切换模式

### 🎨 最新布局优化（v2.1）
- ✅ **居中标题**：系统标题和页面标题居中显示，更美观
- ✅ **优化对话区域**：对话框占据更大区域（4:1比例），提升聊天体验
- ✅ **紧凑侧边栏**：控制面板更紧凑，节省空间
- ✅ **欢迎界面**：新用户看到友好的欢迎信息和使用提示
- ✅ **响应式布局**：自适应不同屏幕尺寸，优化显示效果
- ✅ **视觉优化**：添加边框、背景色等视觉元素，提升界面美观度

### 🗂️ 对话管理优化（v2.2）
- ✅ **侧边栏布局**：AI问答页面改为侧边栏布局，与知识库搜索保持一致
- ✅ **多会话支持**：支持创建、管理多个独立的对话会话
- ✅ **会话切换**：可以在不同对话之间自由切换，保持上下文独立
- ✅ **会话删除**：可以删除不需要的对话会话（保护默认对话）
- ✅ **移除统计模块**：简化界面，专注于对话体验
- ✅ **统一界面风格**：两个功能页面保持一致的布局和交互方式

### 🎛️ 侧边栏统一控制（v2.3）
- ✅ **页面切换移至侧边栏**：功能选择统一在侧边栏进行，界面更简洁
- ✅ **删除统计功能**：完全移除对话统计信息，专注核心功能
- ✅ **简化操作流程**：所有控制功能集中在侧边栏，操作更直观
- ✅ **统一交互体验**：两个功能页面的切换和控制方式完全一致
- ✅ **界面更加简洁**：主区域专注于内容展示，控制功能收纳整齐